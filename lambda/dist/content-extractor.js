"use strict";
/**
 * Smart content extraction for cost-effective AI analysis
 * Prioritizes high-impact content while reducing token usage by 60-80%
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.extractPriorityContent = extractPriorityContent;
const jsdom_1 = require("jsdom");
/**
 * Extract high-priority content for AI analysis
 */
function extractPriorityContent(html, url) {
    const dom = new jsdom_1.JSDOM(html);
    const document = dom.window.document;
    // Extract basic metadata
    const title = document.querySelector('title')?.textContent?.trim() || '';
    const metaDescription = document.querySelector('meta[name="description"]')?.getAttribute('content')?.trim() || '';
    // Extract headings with hierarchy
    const headings = {
        h1: extractTextFromElements(document.querySelectorAll('h1')),
        h2: extractTextFromElements(document.querySelectorAll('h2')),
        h3: extractTextFromElements(document.querySelectorAll('h3'))
    };
    // Extract key paragraphs (first paragraph of each section, conclusion paragraphs)
    const keyParagraphs = extractKeyParagraphs(document);
    // Extract list items (often contain key features/benefits)
    const listItems = extractListItems(document);
    // Extract call-to-action elements
    const callToActions = extractCallToActions(document);
    // Determine content type
    const contentType = determineContentType(url, title, headings, document);
    // Create optimized content string for AI analysis
    const priorityContent = buildPriorityContent({
        title,
        metaDescription,
        headings,
        keyParagraphs,
        listItems,
        callToActions,
        contentType
    });
    return {
        title,
        metaDescription,
        headings,
        keyParagraphs,
        listItems,
        callToActions,
        contentType,
        wordCount: priorityContent.split(/\s+/).length,
        priorityContent
    };
}
/**
 * Extract text content from NodeList elements
 */
function extractTextFromElements(elements) {
    return Array.from(elements)
        .map(el => el.textContent?.trim() || '')
        .filter(text => text.length > 0)
        .slice(0, 10); // Limit to prevent token overflow
}
/**
 * Extract key paragraphs that are most likely to contain important information
 */
function extractKeyParagraphs(document) {
    const paragraphs = Array.from(document.querySelectorAll('p'));
    const keyParagraphs = [];
    // Get first paragraph (often intro/summary)
    if (paragraphs[0]) {
        const firstP = paragraphs[0].textContent?.trim();
        if (firstP && firstP.length > 50) {
            keyParagraphs.push(firstP);
        }
    }
    // Get paragraphs that follow headings (section introductions)
    const headings = document.querySelectorAll('h1, h2, h3');
    headings.forEach(heading => {
        let nextElement = heading.nextElementSibling;
        while (nextElement && nextElement.tagName !== 'P' && keyParagraphs.length < 8) {
            nextElement = nextElement.nextElementSibling;
        }
        if (nextElement && nextElement.tagName === 'P') {
            const text = nextElement.textContent?.trim();
            if (text && text.length > 50 && !keyParagraphs.includes(text)) {
                keyParagraphs.push(text);
            }
        }
    });
    // Get conclusion paragraphs (often contain key benefits/summaries)
    const conclusionKeywords = ['conclusion', 'summary', 'benefits', 'why choose', 'get started'];
    paragraphs.forEach(p => {
        const text = p.textContent?.toLowerCase() || '';
        if (conclusionKeywords.some(keyword => text.includes(keyword)) && keyParagraphs.length < 10) {
            const fullText = p.textContent?.trim();
            if (fullText && fullText.length > 50 && !keyParagraphs.includes(fullText)) {
                keyParagraphs.push(fullText);
            }
        }
    });
    return keyParagraphs.slice(0, 8); // Limit to most important paragraphs
}
/**
 * Extract list items that often contain key features or benefits
 */
function extractListItems(document) {
    const lists = document.querySelectorAll('ul, ol');
    const items = [];
    lists.forEach(list => {
        const listItems = list.querySelectorAll('li');
        listItems.forEach(item => {
            const text = item.textContent?.trim();
            if (text && text.length > 10 && text.length < 200) {
                items.push(text);
            }
        });
    });
    return items.slice(0, 15); // Limit to prevent token overflow
}
/**
 * Extract call-to-action elements
 */
function extractCallToActions(document) {
    const ctaSelectors = [
        'button',
        'a[class*="btn"]',
        'a[class*="button"]',
        'a[class*="cta"]',
        '[class*="call-to-action"]'
    ];
    const ctas = [];
    ctaSelectors.forEach(selector => {
        const elements = document.querySelectorAll(selector);
        elements.forEach(el => {
            const text = el.textContent?.trim();
            if (text && text.length > 2 && text.length < 50) {
                ctas.push(text);
            }
        });
    });
    return [...new Set(ctas)].slice(0, 10); // Remove duplicates and limit
}
/**
 * Determine content type based on URL patterns and content analysis
 */
function determineContentType(url, title, headings, document) {
    const urlLower = url.toLowerCase();
    const titleLower = title.toLowerCase();
    const allHeadings = [...headings.h1, ...headings.h2, ...headings.h3].join(' ').toLowerCase();
    // Product page indicators
    if (urlLower.includes('/product') ||
        urlLower.includes('/shop') ||
        titleLower.includes('buy') ||
        allHeadings.includes('price') ||
        document.querySelector('[class*="price"]')) {
        return 'product';
    }
    // Service page indicators
    if (urlLower.includes('/service') ||
        urlLower.includes('/solutions') ||
        titleLower.includes('service') ||
        allHeadings.includes('how we help') ||
        allHeadings.includes('our services')) {
        return 'service';
    }
    // Blog/article indicators
    if (urlLower.includes('/blog') ||
        urlLower.includes('/article') ||
        urlLower.includes('/news') ||
        document.querySelector('article') ||
        document.querySelector('[class*="post"]')) {
        return 'blog';
    }
    // About page indicators
    if (urlLower.includes('/about') ||
        titleLower.includes('about') ||
        allHeadings.includes('our story') ||
        allHeadings.includes('who we are')) {
        return 'about';
    }
    // Contact page indicators
    if (urlLower.includes('/contact') ||
        titleLower.includes('contact') ||
        document.querySelector('form[class*="contact"]') ||
        allHeadings.includes('get in touch')) {
        return 'contact';
    }
    // Homepage indicators (often root URL or contains multiple sections)
    if (url.split('/').length <= 4 &&
        (headings.h2.length > 3 || allHeadings.includes('welcome'))) {
        return 'homepage';
    }
    return 'unknown';
}
/**
 * Build optimized content string for AI analysis
 */
function buildPriorityContent(data) {
    const sections = [];
    // Title and meta (highest priority)
    if (data.title) {
        sections.push(`TITLE: ${data.title}`);
    }
    if (data.metaDescription) {
        sections.push(`META DESCRIPTION: ${data.metaDescription}`);
    }
    // Content type context
    sections.push(`CONTENT TYPE: ${data.contentType}`);
    // Headings structure
    if (data.headings.h1.length > 0) {
        sections.push(`H1 HEADINGS: ${data.headings.h1.join(' | ')}`);
    }
    if (data.headings.h2.length > 0) {
        sections.push(`H2 HEADINGS: ${data.headings.h2.slice(0, 8).join(' | ')}`);
    }
    if (data.headings.h3.length > 0) {
        sections.push(`H3 HEADINGS: ${data.headings.h3.slice(0, 6).join(' | ')}`);
    }
    // Key content paragraphs
    if (data.keyParagraphs.length > 0) {
        sections.push(`KEY CONTENT:\n${data.keyParagraphs.slice(0, 5).join('\n\n')}`);
    }
    // Important features/benefits (from lists)
    if (data.listItems.length > 0) {
        sections.push(`KEY FEATURES/BENEFITS:\n• ${data.listItems.slice(0, 10).join('\n• ')}`);
    }
    // Call-to-actions (indicate user intent/goals)
    if (data.callToActions.length > 0) {
        sections.push(`CALL-TO-ACTIONS: ${data.callToActions.slice(0, 5).join(' | ')}`);
    }
    return sections.join('\n\n');
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udGVudC1leHRyYWN0b3IuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvY29udGVudC1leHRyYWN0b3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOzs7R0FHRzs7QUF1Qkgsd0RBaURDO0FBdEVELGlDQUE4QjtBQWtCOUI7O0dBRUc7QUFDSCxTQUFnQixzQkFBc0IsQ0FBQyxJQUFZLEVBQUUsR0FBVztJQUM5RCxNQUFNLEdBQUcsR0FBRyxJQUFJLGFBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUM1QixNQUFNLFFBQVEsR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQztJQUVyQyx5QkFBeUI7SUFDekIsTUFBTSxLQUFLLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsRUFBRSxXQUFXLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxDQUFDO0lBQ3pFLE1BQU0sZUFBZSxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsMEJBQTBCLENBQUMsRUFBRSxZQUFZLENBQUMsU0FBUyxDQUFDLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxDQUFDO0lBRWxILGtDQUFrQztJQUNsQyxNQUFNLFFBQVEsR0FBRztRQUNmLEVBQUUsRUFBRSx1QkFBdUIsQ0FBQyxRQUFRLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDNUQsRUFBRSxFQUFFLHVCQUF1QixDQUFDLFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM1RCxFQUFFLEVBQUUsdUJBQXVCLENBQUMsUUFBUSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxDQUFDO0tBQzdELENBQUM7SUFFRixrRkFBa0Y7SUFDbEYsTUFBTSxhQUFhLEdBQUcsb0JBQW9CLENBQUMsUUFBUSxDQUFDLENBQUM7SUFFckQsMkRBQTJEO0lBQzNELE1BQU0sU0FBUyxHQUFHLGdCQUFnQixDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBRTdDLGtDQUFr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UUFDbEMsUUFBUSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDaEYsQ0FBQztJQUVELDJDQUEyQztJQUMzQyxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRSxDQUFDO1FBQzlCLFFBQVEsQ0FBQyxJQUFJLENBQUMsNkJBQTZCLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQ3pGLENBQUM7SUFFRCwrQ0FBK0M7SUFDL0MsSUFBSSxJQUFJLENBQUMsYUFBYSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUUsQ0FBQztRQUNsQyxRQUFRLENBQUMsSUFBSSxDQUFDLG9CQUFvQixJQUFJLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUNsRixDQUFDO0lBRUQsT0FBTyxRQUFRLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQy9CLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIFNtYXJ0IGNvbnRlbnQgZXh0cmFjdGlvbiBmb3IgY29zdC1lZmZlY3RpdmUgQUkgYW5hbHlzaXNcbiAqIFByaW9yaXRpemVzIGhpZ2gtaW1wYWN0IGNvbnRlbnQgd2hpbGUgcmVkdWNpbmcgdG9rZW4gdXNhZ2UgYnkgNjAtODAlXG4gKi9cblxuaW1wb3J0IHsgSlNET00gfSBmcm9tICdqc2RvbSc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgRXh0cmFjdGVkQ29udGVudCB7XG4gIHRpdGxlOiBzdHJpbmc7XG4gIG1ldGFEZXNjcmlwdGlvbjogc3RyaW5nO1xuICBoZWFkaW5nczoge1xuICAgIGgxOiBzdHJpbmdbXTtcbiAgICBoMjogc3RyaW5nW107XG4gICAgaDM6IHN0cmluZ1tdO1xuICB9O1xuICBrZXlQYXJhZ3JhcGhzOiBzdHJpbmdbXTtcbiAgbGlzdEl0ZW1zOiBzdHJpbmdbXTtcbiAgY2FsbFRvQWN0aW9uczogc3RyaW5nW107XG4gIGNvbnRlbnRUeXBlOiAncHJvZHVjdCcgfCAnc2VydmljZScgfCAnYmxvZycgfCAnaG9tZXBhZ2UnIHwgJ2Fib3V0JyB8ICdjb250YWN0JyB8ICd1bmtub3duJztcbiAgd29yZENvdW50OiBudW1iZXI7XG4gIHByaW9yaXR5Q29udGVudDogc3RyaW5nOyAvLyBPcHRpbWl6ZWQgY29udGVudCBmb3IgQUkgYW5hbHlzaXNcbn1cblxuLyoqXG4gKiBFeHRyYWN0IGhpZ2gtcHJpb3JpdHkgY29udGVudCBmb3IgQUkgYW5hbHlzaXNcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGV4dHJhY3RQcmlvcml0eUNvbnRlbnQoaHRtbDogc3RyaW5nLCB1cmw6IHN0cmluZyk6IEV4dHJhY3RlZENvbnRlbnQge1xuICBjb25zdCBkb20gPSBuZXcgSlNET00oaHRtbCk7XG4gIGNvbnN0IGRvY3VtZW50ID0gZG9tLndpbmRvdy5kb2N1bWVudDtcbiAgXG4gIC8vIEV4dHJhY3QgYmFzaWMgbWV0YWRhdGFcbiAgY29uc3QgdGl0bGUgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCd0aXRsZScpPy50ZXh0Q29udGVudD8udHJpbSgpIHx8ICcnO1xuICBjb25zdCBtZXRhRGVzY3JpcHRpb24gPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdtZXRhW25hbWU9XCJkZXNjcmlwdGlvblwiXScpPy5nZXRBdHRyaWJ1dGUoJ2NvbnRlbnQnKT8udHJpbSgpIHx8ICcnO1xuICBcbiAgLy8gRXh0cmFjdCBoZWFkaW5ncyB3aXRoIGhpZXJhcmNoeVxuICBjb25zdCBoZWFkaW5ncyA9IHtcbiAgICBoMTogZXh0cmFjdFRleHRGcm9tRWxlbWVudHMoZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnaDEnKSksXG4gICAgaDI6IGV4dHJhY3RUZXh0RnJvbUVsZW1lbnRzKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ2gyJykpLFxuICAgIGgzOiBleHRyYWN0VGV4dEZyb21FbGVtZW50cyhkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCdoMycpKVxuICB9O1xuICBcbiAgLy8gRXh0cmFjdCBrZXkgcGFyYWdyYXBocyAoZmlyc3QgcGFyYWdyYXBoIG9mIGVhY2ggc2VjdGlvbiwgY29uY2x1c2lvbiBwYXJhZ3JhcGhzKVxuICBjb25zdCBrZXlQYXJhZ3JhcGhzID0gZXh0cmFjdEtleVBhcmFncmFwaHMoZG9jdW1lbnQpO1xuICBcbiAgLy8gRXh0cmFjdCBsaXN0IGl0ZW1zIChvZnRlbiBjb250YWluIGtleSBmZWF0dXJlcy9iZW5lZml0cylcbiAgY29uc3QgbGlzdEl0ZW1zID0gZXh0cmFjdExpc3RJdGVtcyhkb2N1bWVudCk7XG4gIFxuICAvLyBFeHRyYWN0IGNhbGwtdG8tYWN0aW9uIGVsZW1lbnRzXG4gIGNvbnN0IGNhbGxUb0FjdGlvbnMgPSBleHRyYWN0Q2FsbFRvQWN0aW9ucyhkb2N1bWVudCk7XG4gIFxuICAvLyBEZXRlcm1pbmUgY29udGVudCB0eXBlXG4gIGNvbnN0IGNvbnRlbnRUeXBlID0gZGV0ZXJtaW5lQ29udGVudFR5cGUodXJsLCB0aXRsZSwgaGVhZGluZ3MsIGRvY3VtZW50KTtcbiAgXG4gIC8vIENyZWF0ZSBvcHRpbWl6ZWQgY29udGVudCBzdHJpbmcgZm9yIEFJIGFuYWx5c2lzXG4gIGNvbnN0IHByaW9yaXR5Q29udGVudCA9IGJ1aWxkUHJpb3JpdHlDb250ZW50KHtcbiAgICB0aXRsZSxcbiAgICBtZXRhRGVzY3JpcHRpb24sXG4gICAgaGVhZGluZ3MsXG4gICAga2V5UGFyYWdyYXBocyxcbiAgICBsaXN0SXRlbXMsXG4gICAgY2FsbFRvQWN0aW9ucyxcbiAgICBjb250ZW50VHlwZVxuICB9KTtcbiAgXG4gIHJldHVybiB7XG4gICAgdGl0bGUsXG4gICAgbWV0YURlc2NyaXB0aW9uLFxuICAgIGhlYWRpbmdzLFxuICAgIGtleVBhcmFncmFwaHMsXG4gICAgbGlzdEl0ZW1zLFxuICAgIGNhbGxUb0FjdGlvbnMsXG4gICAgY29udGVudFR5cGUsXG4gICAgd29yZENvdW50OiBwcmlvcml0eUNvbnRlbnQuc3BsaXQoL1xccysvKS5sZW5ndGgsXG4gICAgcHJpb3JpdHlDb250ZW50XG4gIH07XG59XG5cbi8qKlxuICogRXh0cmFjdCB0ZXh0IGNvbnRlbnQgZnJvbSBOb2RlTGlzdCBlbGVtZW50c1xuICovXG5mdW5jdGlvbiBleHRyYWN0VGV4dEZyb21FbGVtZW50cyhlbGVtZW50czogTm9kZUxpc3RPZjxFbGVtZW50Pik6IHN0cmluZ1tdIHtcbiAgcmV0dXJuIEFycmF5LmZyb20oZWxlbWVudHMpXG4gICAgLm1hcChlbCA9PiBlbC50ZXh0Q29udGVudD8udHJpbSgpIHx8ICcnKVxuICAgIC5maWx0ZXIodGV4dCA9PiB0ZXh0Lmxlbmd0aCA+IDApXG4gICAgLnNsaWNlKDAsIDEwKTsgLy8gTGltaXQgdG8gcHJldmVudCB0b2tlbiBvdmVyZmxvd1xufVxuXG4vKipcbiAqIEV4dHJhY3Qga2V5IHBhcmFncmFwaHMgdGhhdCBhcmUgbW9zdCBsaWtlbHkgdG8gY29udGFpbiBpbXBvcnRhbnQgaW5mb3JtYXRpb25cbiAqL1xuZnVuY3Rpb24gZXh0cmFjdEtleVBhcmFncmFwaHMoZG9jdW1lbnQ6IERvY3VtZW50KTogc3RyaW5nW10ge1xuICBjb25zdCBwYXJhZ3JhcGhzID0gQXJyYXkuZnJvbShkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCdwJykpO1xuICBjb25zdCBrZXlQYXJhZ3JhcGhzOiBzdHJpbmdbXSA9IFtdO1xuICBcbiAgLy8gR2V0IGZpcnN0IHBhcmFncmFwaCAob2Z0ZW4gaW50cm8vc3VtbWFyeSlcbiAgaWYgKHBhcmFncmFwaHNbMF0pIHtcbiAgICBjb25zdCBmaXJzdFAgPSBwYXJhZ3JhcGhzWzBdLnRleHRDb250ZW50Py50cmltKCk7XG4gICAgaWYgKGZpcnN0UCAmJiBmaXJzdFAubGVuZ3RoID4gNTApIHtcbiAgICAgIGtleVBhcmFncmFwaHMucHVzaChmaXJzdFApO1xuICAgIH1cbiAgfVxuICBcbiAgLy8gR2V0IHBhcmFncmFwaHMgdGhhdCBmb2xsb3cgaGVhZGluZ3MgKHNlY3Rpb24gaW50cm9kdWN0aW9ucylcbiAgY29uc3QgaGVhZGluZ3MgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCdoMSwgaDIsIGgzJyk7XG4gIGhlYWRpbmdzLmZvckVhY2goaGVhZGluZyA9PiB7XG4gICAgbGV0IG5leHRFbGVtZW50ID0gaGVhZGluZy5uZXh0RWxlbWVudFNpYmxpbmc7XG4gICAgd2hpbGUgKG5leHRFbGVtZW50ICYmIG5leHRFbGVtZW50LnRhZ05hbWUgIT09ICdQJyAmJiBrZXlQYXJhZ3JhcGhzLmxlbmd0aCA8IDgpIHtcbiAgICAgIG5leHRFbGVtZW50ID0gbmV4dEVsZW1lbnQubmV4dEVsZW1lbnRTaWJsaW5nO1xuICAgIH1cbiAgICBpZiAobmV4dEVsZW1lbnQgJiYgbmV4dEVsZW1lbnQudGFnTmFtZSA9PT0gJ1AnKSB7XG4gICAgICBjb25zdCB0ZXh0ID0gbmV4dEVsZW1lbnQudGV4dENvbnRlbnQ/LnRyaW0oKTtcbiAgICAgIGlmICh0ZXh0ICYmIHRleHQubGVuZ3RoID4gNTAgJiYgIWtleVBhcmFncmFwaHMuaW5jbHVkZXModGV4dCkpIHtcbiAgICAgICAga2V5UGFyYWdyYXBocy5wdXNoKHRleHQpO1xuICAgICAgfVxuICAgIH1cbiAgfSk7XG4gIFxuICAvLyBHZXQgY29uY2x1c2lvbiBwYXJhZ3JhcGhzIChvZnRlbiBjb250YWluIGtleSBiZW5lZml0cy9zdW1tYXJpZXMpXG4gIGNvbnN0IGNvbmNsdXNpb25LZXl3b3JkcyA9IFsnY29uY2x1c2lvbicsICdzdW1tYXJ5JywgJ2JlbmVmaXRzJywgJ3doeSBjaG9vc2UnLCAnZ2V0IHN0YXJ0ZWQnXTtcbiAgcGFyYWdyYXBocy5mb3JFYWNoKHAgPT4ge1xuICAgIGNvbnN0IHRleHQgPSBwLnRleHRDb250ZW50Py50b0xvd2VyQ2FzZSgpIHx8ICcnO1xuICAgIGlmIChjb25jbHVzaW9uS2V5d29yZHMuc29tZShrZXl3b3JkID0+IHRleHQuaW5jbHVkZXMoa2V5d29yZCkpICYmIGtleVBhcmFncmFwaHMubGVuZ3RoIDwgMTApIHtcbiAgICAgIGNvbnN0IGZ1bGxUZXh0ID0gcC50ZXh0Q29udGVudD8udHJpbSgpO1xuICAgICAgaWYgKGZ1bGxUZXh0ICYmIGZ1bGxUZXh0Lmxlbmd0aCA+IDUwICYmICFrZXlQYXJhZ3JhcGhzLmluY2x1ZGVzKGZ1bGxUZXh0KSkge1xuICAgICAgICBrZXlQYXJhZ3JhcGhzLnB1c2goZnVsbFRleHQpO1xuICAgICAgfVxuICAgIH1cbiAgfSk7XG4gIFxuICByZXR1cm4ga2V5UGFyYWdyYXBocy5zbGljZSgwLCA4KTsgLy8gTGltaXQgdG8gbW9zdCBpbXBvcnRhbnQgcGFyYWdyYXBoc1xufVxuXG4vKipcbiAqIEV4dHJhY3QgbGlzdCBpdGVtcyB0aGF0IG9mdGVuIGNvbnRhaW4ga2V5IGZlYXR1cmVzIG9yIGJlbmVmaXRzXG4gKi9cbmZ1bmN0aW9uIGV4dHJhY3RMaXN0SXRlbXMoZG9jdW1lbnQ6IERvY3VtZW50KTogc3RyaW5nW10ge1xuICBjb25zdCBsaXN0cyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ3VsLCBvbCcpO1xuICBjb25zdCBpdGVtczogc3RyaW5nW10gPSBbXTtcbiAgXG4gIGxpc3RzLmZvckVhY2gobGlzdCA9PiB7XG4gICAgY29uc3QgbGlzdEl0ZW1zID0gbGlzdC5xdWVyeVNlbGVjdG9yQWxsKCdsaScpO1xuICAgIGxpc3RJdGVtcy5mb3JFYWNoKGl0ZW0gPT4ge1xuICAgICAgY29uc3QgdGV4dCA9IGl0ZW0udGV4dENvbnRlbnQ/LnRyaW0oKTtcbiAgICAgIGlmICh0ZXh0ICYmIHRleHQubGVuZ3RoID4gMTAgJiYgdGV4dC5sZW5ndGggPCAyMDApIHtcbiAgICAgICAgaXRlbXMucHVzaCh0ZXh0KTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfSk7XG4gIFxuICByZXR1cm4gaXRlbXMuc2xpY2UoMCwgMTUpOyAvLyBMaW1pdCB0byBwcmV2ZW50IHRva2VuIG92ZXJmbG93XG59XG5cbi8qKlxuICogRXh0cmFjdCBjYWxsLXRvLWFjdGlvbiBlbGVtZW50c1xuICovXG5mdW5jdGlvbiBleHRyYWN0Q2FsbFRvQWN0aW9ucyhkb2N1bWVudDogRG9jdW1lbnQpOiBzdHJpbmdbXSB7XG4gIGNvbnN0IGN0YVNlbGVjdG9ycyA9IFtcbiAgICAnYnV0dG9uJyxcbiAgICAnYVtjbGFzcyo9XCJidG5cIl0nLFxuICAgICdhW2NsYXNzKj1cImJ1dHRvblwiXScsXG4gICAgJ2FbY2xhc3MqPVwiY3RhXCJdJyxcbiAgICAnW2NsYXNzKj1cImNhbGwtdG8tYWN0aW9uXCJdJ1xuICBdO1xuICBcbiAgY29uc3QgY3Rhczogc3RyaW5nW10gPSBbXTtcbiAgXG4gIGN0YVNlbGVjdG9ycy5mb3JFYWNoKHNlbGVjdG9yID0+IHtcbiAgICBjb25zdCBlbGVtZW50cyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoc2VsZWN0b3IpO1xuICAgIGVsZW1lbnRzLmZvckVhY2goZWwgPT4ge1xuICAgICAgY29uc3QgdGV4dCA9IGVsLnRleHRDb250ZW50Py50cmltKCk7XG4gICAgICBpZiAodGV4dCAmJiB0ZXh0Lmxlbmd0aCA+IDIgJiYgdGV4dC5sZW5ndGggPCA1MCkge1xuICAgICAgICBjdGFzLnB1c2godGV4dCk7XG4gICAgICB9XG4gICAgfSk7XG4gIH0pO1xuICBcbiAgcmV0dXJuIFsuLi5uZXcgU2V0KGN0YXMpXS5zbGljZSgwLCAxMCk7IC8vIFJlbW92ZSBkdXBsaWNhdGVzIGFuZCBsaW1pdFxufVxuXG4vKipcbiAqIERldGVybWluZSBjb250ZW50IHR5cGUgYmFzZWQgb24gVVJMIHBhdHRlcm5zIGFuZCBjb250ZW50IGFuYWx5c2lzXG4gKi9cbmZ1bmN0aW9uIGRldGVybWluZUNvbnRlbnRUeXBlKFxuICB1cmw6IHN0cmluZywgXG4gIHRpdGxlOiBzdHJpbmcsIFxuICBoZWFkaW5nczogeyBoMTogc3RyaW5nW107IGgyOiBzdHJpbmdbXTsgaDM6IHN0cmluZ1tdIH0sXG4gIGRvY3VtZW50OiBEb2N1bWVudFxuKTogRXh0cmFjdGVkQ29udGVudFsnY29udGVudFR5cGUnXSB7XG4gIGNvbnN0IHVybExvd2VyID0gdXJsLnRvTG93ZXJDYXNlKCk7XG4gIGNvbnN0IHRpdGxlTG93ZXIgPSB0aXRsZS50b0xvd2VyQ2FzZSgpO1xuICBjb25zdCBhbGxIZWFkaW5ncyA9IFsuLi5oZWFkaW5ncy5oMSwgLi4uaGVhZGluZ3MuaDIsIC4uLmhlYWRpbmdzLmgzXS5qb2luKCcgJykudG9Mb3dlckNhc2UoKTtcbiAgXG4gIC8vIFByb2R1Y3QgcGFnZSBpbmRpY2F0b3JzXG4gIGlmICh1cmxMb3dlci5pbmNsdWRlcygnL3Byb2R1Y3QnKSB8fCBcbiAgICAgIHVybExvd2VyLmluY2x1ZGVzKCcvc2hvcCcpIHx8XG4gICAgICB0aXRsZUxvd2VyLmluY2x1ZGVzKCdidXknKSB8fFxuICAgICAgYWxsSGVhZGluZ3MuaW5jbHVkZXMoJ3ByaWNlJykgfHxcbiAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ1tjbGFzcyo9XCJwcmljZVwiXScpKSB7XG4gICAgcmV0dXJuICdwcm9kdWN0JztcbiAgfVxuICBcbiAgLy8gU2VydmljZSBwYWdlIGluZGljYXRvcnNcbiAgaWYgKHVybExvd2VyLmluY2x1ZGVzKCcvc2VydmljZScpIHx8XG4gICAgICB1cmxMb3dlci5pbmNsdWRlcygnL3NvbHV0aW9ucycpIHx8XG4gICAgICB0aXRsZUxvd2VyLmluY2x1ZGVzKCdzZXJ2aWNlJykgfHxcbiAgICAgIGFsbEhlYWRpbmdzLmluY2x1ZGVzKCdob3cgd2UgaGVscCcpIHx8XG4gICAgICBhbGxIZWFkaW5ncy5pbmNsdWRlcygnb3VyIHNlcnZpY2VzJykpIHtcbiAgICByZXR1cm4gJ3NlcnZpY2UnO1xuICB9XG4gIFxuICAvLyBCbG9nL2FydGljbGUgaW5kaWNhdG9yc1xuICBpZiAodXJsTG93ZXIuaW5jbHVkZXMoJy9ibG9nJykgfHxcbiAgICAgIHVybExvd2VyLmluY2x1ZGVzKCcvYXJ0aWNsZScpIHx8XG4gICAgICB1cmxMb3dlci5pbmNsdWRlcygnL25ld3MnKSB8fFxuICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcignYXJ0aWNsZScpIHx8XG4gICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdbY2xhc3MqPVwicG9zdFwiXScpKSB7XG4gICAgcmV0dXJuICdibG9nJztcbiAgfVxuICBcbiAgLy8gQWJvdXQgcGFnZSBpbmRpY2F0b3JzXG4gIGlmICh1cmxMb3dlci5pbmNsdWRlcygnL2Fib3V0JykgfHxcbiAgICAgIHRpdGxlTG93ZXIuaW5jbHVkZXMoJ2Fib3V0JykgfHxcbiAgICAgIGFsbEhlYWRpbmdzLmluY2x1ZGVzKCdvdXIgc3RvcnknKSB8fFxuICAgICAgYWxsSGVhZGluZ3MuaW5jbHVkZXMoJ3dobyB3ZSBhcmUnKSkge1xuICAgIHJldHVybiAnYWJvdXQnO1xuICB9XG4gIFxuICAvLyBDb250YWN0IHBhZ2UgaW5kaWNhdG9yc1xuICBpZiAodXJsTG93ZXIuaW5jbHVkZXMoJy9jb250YWN0JykgfHxcbiAgICAgIHRpdGxlTG93ZXIuaW5jbHVkZXMoJ2NvbnRhY3QnKSB8fFxuICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcignZm9ybVtjbGFzcyo9XCJjb250YWN0XCJdJykgfHxcbiAgICAgIGFsbEhlYWRpbmdzLmluY2x1ZGVzKCdnZXQgaW4gdG91Y2gnKSkge1xuICAgIHJldHVybiAnY29udGFjdCc7XG4gIH1cbiAgXG4gIC8vIEhvbWVwYWdlIGluZGljYXRvcnMgKG9mdGVuIHJvb3QgVVJMIG9yIGNvbnRhaW5zIG11bHRpcGxlIHNlY3Rpb25zKVxuICBpZiAodXJsLnNwbGl0KCcvJykubGVuZ3RoIDw9IDQgJiYgXG4gICAgICAoaGVhZGluZ3MuaDIubGVuZ3RoID4gMyB8fCBhbGxIZWFkaW5ncy5pbmNsdWRlcygnd2VsY29tZScpKSkge1xuICAgIHJldHVybiAnaG9tZXBhZ2UnO1xuICB9XG4gIFxuICByZXR1cm4gJ3Vua25vd24nO1xufVxuXG4vKipcbiAqIEJ1aWxkIG9wdGltaXplZCBjb250ZW50IHN0cmluZyBmb3IgQUkgYW5hbHlzaXNcbiAqL1xuZnVuY3Rpb24gYnVpbGRQcmlvcml0eUNvbnRlbnQoZGF0YToge1xuICB0aXRsZTogc3RyaW5nO1xuICBtZXRhRGVzY3JpcHRpb246IHN0cmluZztcbiAgaGVhZGluZ3M6IHsgaDE6IHN0cmluZ1tdOyBoMjogc3RyaW5nW107IGgzOiBzdHJpbmdbXSB9O1xuICBrZXlQYXJhZ3JhcGhzOiBzdHJpbmdbXTtcbiAgbGlzdEl0ZW1zOiBzdHJpbmdbXTtcbiAgY2FsbFRvQWN0aW9uczogc3RyaW5nW107XG4gIGNvbnRlbnRUeXBlOiBzdHJpbmc7XG59KTogc3RyaW5nIHtcbiAgY29uc3Qgc2VjdGlvbnM6IHN0cmluZ1tdID0gW107XG4gIFxuICAvLyBUaXRsZSBhbmQgbWV0YSAoaGlnaGVzdCBwcmlvcml0eSlcbiAgaWYgKGRhdGEudGl0bGUpIHtcbiAgICBzZWN0aW9ucy5wdXNoKGBUSVRMRTogJHtkYXRhLnRpdGxlfWApO1xuICB9XG4gIFxuICBpZiAoZGF0YS5tZXRhRGVzY3JpcHRpb24pIHtcbiAgICBzZWN0aW9ucy5wdXNoKGBNRVRBIERFU0NSSVBUSU9OOiAke2RhdGEubWV0YURlc2NyaXB0aW9ufWApO1xuICB9XG4gIFxuICAvLyBDb250ZW50IHR5cGUgY29udGV4dFxuICBzZWN0aW9ucy5wdXNoKGBDT05URU5UIFRZUEU6ICR7ZGF0YS5jb250ZW50VHlwZX1gKTtcbiAgXG4gIC8vIEhlYWRpbmdzIHN0cnVjdHVyZVxuICBpZiAoZGF0YS5oZWFkaW5ncy5oMS5sZW5ndGggPiAwKSB7XG4gICAgc2VjdGlvbnMucHVzaChgSDEgSEVBRElOR1M6ICR7ZGF0YS5oZWFkaW5ncy5oMS5qb2luKCcgfCAnKX1gKTtcbiAgfVxuICBcbiAgaWYgKGRhdGEuaGVhZGluZ3MuaDIubGVuZ3RoID4gMCkge1xuICAgIHNlY3Rpb25zLnB1c2goYEgyIEhFQURJTkdTOiAke2RhdGEuaGVhZGluZ3MuaDIuc2xpY2UoMCwgOCkuam9pbignIHwgJyl9YCk7XG4gIH1cbiAgXG4gIGlmIChkYXRhLmhlYWRpbmdzLmgzLmxlbmd0aCA+IDApIHtcbiAgICBzZWN0aW9ucy5wdXNoKGBIMyBIRUFESU5HUzogJHtkYXRhLmhlYWRpbmdzLmgzLnNsaWNlKDAsIDYpLmpvaW4oJyB8ICcpfWApO1xuICB9XG4gIFxuICAvLyBLZXkgY29udGVudCBwYXJhZ3JhcGhzXG4gIGlmIChkYXRhLmtleVBhcmFncmFwaHMubGVuZ3RoID4gMCkge1xuICAgIHNlY3Rpb25zLnB1c2goYEtFWSBDT05URU5UOlxcbiR7ZGF0YS5rZXlQYXJhZ3JhcGhzLnNsaWNlKDAsIDUpLmpvaW4oJ1xcblxcbicpfWApO1xuICB9XG4gIFxuICAvLyBJbXBvcnRhbnQgZmVhdHVyZXMvYmVuZWZpdHMgKGZyb20gbGlzdHMpXG4gIGlmIChkYXRhLmxpc3RJdGVtcy5sZW5ndGggPiAwKSB7XG4gICAgc2VjdGlvbnMucHVzaChgS0VZIEZFQVRVUkVTL0JFTkVGSVRTOlxcbuKAoiAke2RhdGEubGlzdEl0ZW1zLnNsaWNlKDAsIDEwKS5qb2luKCdcXG7igKIgJyl9YCk7XG4gIH1cbiAgXG4gIC8vIENhbGwtdG8tYWN0aW9ucyAoaW5kaWNhdGUgdXNlciBpbnRlbnQvZ29hbHMpXG4gIGlmIChkYXRhLmNhbGxUb0FjdGlvbnMubGVuZ3RoID4gMCkge1xuICAgIHNlY3Rpb25zLnB1c2goYENBTEwtVE8tQUNUSU9OUzogJHtkYXRhLmNhbGxUb0FjdGlvbnMuc2xpY2UoMCwgNSkuam9pbignIHwgJyl9YCk7XG4gIH1cbiAgXG4gIHJldHVybiBzZWN0aW9ucy5qb2luKCdcXG5cXG4nKTtcbn0gIl19